<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="report_info">
	
	<!-- operation report: authserver auth sync count -->
	<select id="reportAuthCount" parameterClass="reportQueryInfo" resultClass="reportDataInfo">
		<![CDATA[
    		SELECT ta.a AS authSumCount,tb.b AS authSuccessCount,tc.c AS authFaildCount,td.d AS syncSumCount,te.e AS syncSuccessCount,tf.f AS syncFaildCount 
				FROM
				(SELECT COUNT(*) AS a FROM otppms_loginfo WHERE moduletype ='0' AND actionid in('1001','1024','1026') AND logtime>=#beginDateLong# AND logtime<#endDateLong# ]]><include refid="queryReportCondition" />  <![CDATA[) ta,
				(SELECT COUNT(*) AS b FROM otppms_loginfo WHERE moduletype ='0' AND actionid in('1001','1024','1026') AND logtime>=#beginDateLong# AND logtime<#endDateLong# AND actionresult ='1' ]]><include refid="queryReportCondition" />  <![CDATA[) tb,
				(SELECT COUNT(*) AS c FROM otppms_loginfo WHERE moduletype ='0' AND actionid in('1001','1024','1026') AND logtime>=#beginDateLong# AND logtime<#endDateLong# AND actionresult ='0' ]]><include refid="queryReportCondition" />  <![CDATA[) tc,
				(SELECT COUNT(*) AS d FROM otppms_loginfo WHERE moduletype ='0' AND actionid = '1002' AND logtime>=#beginDateLong# AND logtime<#endDateLong# ]]><include refid="queryReportCondition" />  <![CDATA[) td,
				(SELECT COUNT(*) AS e FROM otppms_loginfo WHERE moduletype ='0' AND actionid = '1002' AND logtime>=#beginDateLong# AND logtime<#endDateLong# AND actionresult ='1' ]]><include refid="queryReportCondition" />  <![CDATA[) te,
				(SELECT COUNT(*) AS f FROM otppms_loginfo WHERE moduletype ='0' AND actionid = '1002' AND logtime>=#beginDateLong# AND logtime<#endDateLong# AND actionresult ='0' ]]><include refid="queryReportCondition" />  <![CDATA[) tf
    	]]>
	</select>
	
	<!-- operation report: authserver time auth count -->
	<select id="reportAuthCountByTime" parameterClass="reportQueryInfo" resultClass="reportDataInfo">
		<![CDATA[
    		SELECT ta.a AS authSumCount,tb.b AS authSuccessCount,tc.c AS authFaildCount 
				FROM
				(SELECT COUNT(*) AS a FROM otppms_loginfo WHERE moduletype ='0' AND actionid in('1001','1024','1026') AND logtime>=#beginDateLong# AND logtime<#endDateLong# ]]><include refid="queryReportCondition" />  <![CDATA[) ta,
				(SELECT COUNT(*) AS b FROM otppms_loginfo WHERE moduletype ='0' AND actionid in('1001','1024','1026') AND logtime>=#beginDateLong# AND logtime<#endDateLong# AND actionresult ='1' ]]><include refid="queryReportCondition" />  <![CDATA[) tb,
				(SELECT COUNT(*) AS c FROM otppms_loginfo WHERE moduletype ='0' AND actionid in('1001','1024','1026') AND logtime>=#beginDateLong# AND logtime<#endDateLong# AND actionresult ='0' ]]><include refid="queryReportCondition" />  <![CDATA[) tc 
    	]]>
	</select>
	
	<!-- operation report: portal access count -->
	<select id="reportPortalCount" parameterClass="reportQueryInfo" resultClass="reportDataInfo">
		<![CDATA[
    		SELECT ta.a AS accessSumCount,tb.b AS accessSuccessCount,tc.c AS accessFaildCount 
				FROM
				(SELECT COUNT(*) AS a FROM otppms_loginfo WHERE moduletype ='1' AND actionid = '2001' AND logtime>=#beginDateLong# AND logtime<#endDateLong# ]]><include refid="queryReportCondition" />  <![CDATA[) ta,
				(SELECT COUNT(*) AS b FROM otppms_loginfo WHERE moduletype ='1' AND actionid = '2001' AND logtime>=#beginDateLong# AND logtime<#endDateLong# AND actionresult ='1' ]]><include refid="queryReportCondition" />  <![CDATA[) tb,
				(SELECT COUNT(*) AS c FROM otppms_loginfo WHERE moduletype ='1' AND actionid = '2001' AND logtime>=#beginDateLong# AND logtime<#endDateLong# AND actionresult ='0' ]]><include refid="queryReportCondition" />  <![CDATA[) tc 
    	]]>
	</select>

	<!-- user report: user count report -->
	<select id="reportUserCountToMain" parameterClass="reportQueryInfo" resultClass="reportDataInfo">
		<![CDATA[
    		SELECT sumc.sumcount AS commonLong1,lockc.lockcount AS commonLong3,bindc.bindcount AS commonLong2
			   FROM 
		       (SELECT COUNT(userid)AS sumcount FROM otppms_userinfo WHERE createtime>=#beginDateLong# AND createtime<#endDateLong#]]> <![CDATA[) sumc,
               (SELECT COUNT(userid)AS lockcount FROM otppms_userinfo WHERE locked!='0' AND createtime>=#beginDateLong# AND createtime<#endDateLong#]]>  <![CDATA[) lockc,
               (SELECT COUNT(bb.userid)AS bindcount FROM (SELECT distinct(ft.userid) FROM otppms_user_token ft WHERE ft.domainid IS NOT NULL and ft.bindtime>=#beginDateLong# AND ft.bindtime<#endDateLong# ]]>  <![CDATA[) bb) bindc 
    	]]>
	</select>
	
	<select id="reportUserCount" parameterClass="reportQueryInfo" resultClass="reportDataInfo">
		<![CDATA[
    		SELECT sumc.sumcount AS commonLong1,lockc.lockcount AS commonLong3,bindc.bindcount AS commonLong2
			   FROM 
		       (SELECT COUNT(userid)AS sumcount FROM otppms_userinfo WHERE createtime>=#beginDateLong# AND createtime<#endDateLong# ]]><include refid="queryReportCondition" />  <![CDATA[) sumc,
               (SELECT COUNT(userid)AS lockcount FROM otppms_userinfo WHERE locked!='0' AND createtime>=#beginDateLong# AND createtime<#endDateLong# ]]><include refid="queryReportCondition" />  <![CDATA[) lockc,
               (SELECT COUNT(bb.userid)AS bindcount FROM (SELECT distinct(ft.userid) FROM otppms_user_token ft left join otppms_userinfo fu on ft.userid = fu.userid WHERE ft.domainid IS NOT NULL and ft.bindtime>=#beginDateLong# AND ft.bindtime<#endDateLong# ]]><include refid="queryReportConditionC" />  <![CDATA[) bb) bindc 
    	]]>
	</select>
	
	<!-- user report: user authtype count report -->
	<select id="reportUserCountByAuthType" parameterClass="reportQueryInfo" resultClass="reportDataInfo">
		<![CDATA[
			SELECT ta.a AS commonLong1,tb.b AS commonLong2,tc.c AS commonLong3,td.d AS commonLong4
				FROM 
				(SELECT COUNT(localauth) AS a FROM otppms_userinfo WHERE localauth = '2'  ]]><include refid="queryReportCondition" />  <![CDATA[) ta,
				(SELECT COUNT(localauth) AS b FROM otppms_userinfo WHERE localauth = '0'  ]]><include refid="queryReportCondition" />  <![CDATA[) tb,
				(SELECT COUNT(localauth) AS c FROM otppms_userinfo WHERE localauth = '1'  ]]><include refid="queryReportCondition" />  <![CDATA[) tc,
				(SELECT COUNT(localauth) AS d FROM otppms_userinfo WHERE localauth = '3'  ]]><include refid="queryReportCondition" />  <![CDATA[) td
		]]>
	</select>
	
	<!-- token report: token state count report -->
	<select id="reportTknCountByState" parameterClass="reportQueryInfo" resultClass="reportDataInfo">
		<![CDATA[
			SELECT ta.a AS tokenSumCount,tb.b AS bindCount,tc.c AS enableTknCount,td.d AS loseTknCount,te.e AS invalidTknCount,tf.f AS lockTknCount,tg.g AS commonLong1
				FROM
				(SELECT COUNT(*) AS a FROM otppms_tokeninfo WHERE 1=1 ]]><include refid="queryReportCondition" />  <![CDATA[ ) ta,
				(SELECT COUNT(*) AS b FROM (SELECT ft.token FROM otppms_user_token ft left join otppms_tokeninfo fu on ft.token = fu.token where 1=1 ]]><include refid="queryReportConditionC" />  <![CDATA[ GROUP BY ft.token) bb) tb,
				(SELECT COUNT(*) AS c FROM otppms_tokeninfo WHERE enabled ='1' ]]><include refid="queryReportCondition" />  <![CDATA[) tc,
				(SELECT COUNT(*) AS d FROM otppms_tokeninfo WHERE lost ='1' ]]><include refid="queryReportCondition" />  <![CDATA[) td,
				(SELECT COUNT(*) AS e FROM otppms_tokeninfo WHERE logout ='1' ]]><include refid="queryReportCondition" />  <![CDATA[) te,
				(SELECT COUNT(*) AS f FROM otppms_tokeninfo WHERE locked !='0' ]]><include refid="queryReportCondition" />  <![CDATA[) tf,
				(SELECT COUNT(*) AS g FROM otppms_tokeninfo WHERE authmethod ='1' ]]><include refid="queryReportCondition" />  <![CDATA[) tg
		]]>
	</select>
	
	<!-- token report: enable pin token count report -->
	<select id="reportTknCountByEmpin" parameterClass="reportQueryInfo" resultClass="reportDataInfo">
		<![CDATA[
			SELECT ta.a AS tokenSumCount,tb.b AS enableTknCount,tc.c AS enableEmpin
				FROM
				(SELECT COUNT(*) AS a FROM otppms_tokeninfo WHERE 1=1 ]]><include refid="queryReportCondition" />  <![CDATA[) ta,
				(SELECT COUNT(*) AS b FROM otppms_tokeninfo WHERE enabled ='1' ]]><include refid="queryReportCondition" />  <![CDATA[) tb,
				(SELECT COUNT(*) AS c FROM otppms_tokeninfo WHERE authmethod ='1' ]]><include refid="queryReportCondition" />  <![CDATA[) tc
		]]>
	</select>
	
	<!-- token report: token expire time count report -->
	<select id="reportTknCountByExpired" parameterClass="reportQueryInfo" resultClass="reportDataInfo">
		<![CDATA[
			SELECT ta.a AS tokenSumCount,tb.b AS weekExpiredTnkCount,tc.c AS monthExpiredTnkCount,td.d AS quarterExpiredTnkCount,te.e AS moreExpiredTnkCount
				 FROM
				(SELECT COUNT(*) AS a FROM otppms_tokeninfo WHERE 1=1 ]]><include refid="queryReportCondition" />  <![CDATA[) ta,
				(SELECT COUNT(*) AS b FROM otppms_tokeninfo WHERE expiretime <=#weekExpireTime# and expiretime >= #nowtime# ]]><include refid="queryReportCondition" />  <![CDATA[) tb,
				(SELECT COUNT(*) AS c FROM otppms_tokeninfo WHERE expiretime <=#monthExpireTime# and expiretime >= #nowtime# ]]><include refid="queryReportCondition" />  <![CDATA[) tc,
				(SELECT COUNT(*) AS d FROM otppms_tokeninfo WHERE expiretime <=#quarterExpireTime# and expiretime >= #nowtime# ]]><include refid="queryReportCondition" />  <![CDATA[) td,
				(SELECT COUNT(*) AS e FROM otppms_tokeninfo WHERE expiretime >=#moreExpireTime# ]]><include refid="queryReportCondition" />  <![CDATA[) te
		]]>
	</select>
	
	<!-- monitor: same time expire token count -->
	<select id="reportTknsByExpired" parameterClass="reportQueryInfo" resultClass="tokenInfo">
			<![CDATA[
				select token,expiretime from otppms_tokeninfo where 1=1 
			]]>
			<dynamic>
				<isNotEqual compareValue="0" property="monthExpireTime" prepend="and">
					<![CDATA[
						#monthExpireTime#>=expiretime
					]]>
				</isNotEqual>
			</dynamic>
	</select>

	<!-- monitor: report token sum count and bind count -->
	<select id="reportbindTknCount" parameterClass="reportQueryInfo" resultClass="reportDataInfo">
			<![CDATA[			
				SELECT ta.a AS tokenSumCount,tb.b AS bindCount 
				FROM
				(SELECT COUNT(*) AS a FROM otppms_tokeninfo) ta,
				(SELECT COUNT(*) AS b FROM (SELECT token FROM otppms_user_token GROUP BY token) tk) tb
			]]>
	</select>
	
	<!-- monitor: report same time token sync count -->
	<select id="reportSynTknCountByTime" parameterClass="reportQueryInfo" resultClass="int">
			<![CDATA[
				SELECT COUNT(*) AS synCount FROM otppms_loginfo WHERE moduletype ='0' AND actionid = '1002' AND logtime>=#beginDateLong# AND logtime<#endDateLong#
			]]>
	</select>
	
	<!-- export operation : auth sync -->
	<typeAlias alias="userlogInfo" type="com.ft.otp.manager.logs.userlog.entity.UserLogInfo"/>
	<select id="selectAuthSync" resultClass="userlogInfo" parameterClass="reportQueryInfo">
		<![CDATA[
    	 select
    		userid,token,clientip,actionid,actionresult,logtime 
    		from otppms_loginfo where moduletype ='0' AND actionid = #operType# 
    	]]>
    	<isGreaterThan compareValue="0" property="beginDateLong"
				prepend="and">
				createtime>=#beginDateLong#
		</isGreaterThan>
		<isGreaterThan compareValue="0" property="endDateLong"
				prepend="and">
				#endDateLong#>createtime
		</isGreaterThan>
    	<include refid="queryReportCondition" />
    	<![CDATA[       		
        	order by logtime desc 
        ]]>
	</select>
	
	<!-- export user: user count operType =1 locked ，=2 bind，=3 not bind -->
	<typeAlias alias="userInfo" type="com.ft.otp.manager.user.userinfo.entity.UserInfo" />
	<select id="selectUserCount" resultClass="userInfo" parameterClass="reportQueryInfo">
		<![CDATA[
		    SELECT fu.userid AS userid,fu.realname AS realname,fd.domainname AS domainName,fo.orgunitname AS orgunitName 
			FROM otppms_userinfo fu LEFT JOIN otppms_domaininfo fd ON fu.domainid=fd.domainid LEFT JOIN otppms_orgunitinfo fo ON fu.orgunitid = fo.orgunitid
			WHERE 1=1  
         ]]>
        <isEqual compareValue="1" property="operType" prepend="and">
				fu.locked!='0'
		</isEqual>
        <isGreaterThan compareValue="0" property="beginDateLong"
				prepend="and">
				fu.createtime>=#beginDateLong#
		</isGreaterThan>
		<isGreaterThan compareValue="0" property="endDateLong"
				prepend="and">
				#endDateLong#>fu.createtime
		</isGreaterThan>
		<isEqual compareValue="2" property="operType" prepend="and">
				exists (select otppms_user_token.token from
				otppms_user_token where otppms_user_token.userid =
				fu.userid)
		</isEqual>
		<isEqual compareValue="3" property="operType" prepend="and">
				not exists(select otppms_user_token.token from
				otppms_user_token where otppms_user_token.userid =
				fu.userid)
		</isEqual>
		<include refid="queryReportConditionC" />
	</select>	
	
	<!-- export user: user authType operType>0 every localauth query ,operType=-1 enable pin token query -->
	<select id="selectUserAuthType" resultClass="userInfo" parameterClass="reportQueryInfo">
		<![CDATA[
		    SELECT fu.userid AS userid,fu.realname AS realname,fu.localauth AS localauth,otppms_user_token.token AS token , fd.domainname AS domainName,fo.orgunitname AS orgunitName , fu.createtime AS createtime     
   			FROM otppms_userinfo fu LEFT JOIN otppms_user_token ON fu.userid=otppms_user_token.userid AND fu.domainid=otppms_user_token.domainid LEFT JOIN otppms_tokeninfo ON otppms_user_token.token = otppms_tokeninfo.token LEFT JOIN otppms_domaininfo fd ON fu.domainid=fd.domainid LEFT JOIN otppms_orgunitinfo fo ON fu.orgunitid = fo.orgunitid 
   			WHERE 1=1
         ]]>
		<isGreaterThan compareValue="-1" property="operType"
				prepend="and">
				fu.localauth = #operType#
		</isGreaterThan>
		<isEqual compareValue="-1" property="operType" prepend="and">
				otppms_tokeninfo.authmethod ='1'
		</isEqual>
		<include refid="queryReportConditionC" />
	</select>	
	
	
	<!-- export token: token state operType=1 bind ,=2 enable，=3 locked，=4 lost，=5 logout,=6 enabled pin -->
	<select id="selectStateToken" resultClass="tokenInfo" parameterClass="reportQueryInfo">
		<![CDATA[
		    SELECT fu.token AS token ,fs.userid AS userid ,fs.domainid AS domainid
              from otppms_tokeninfo fu left join otppms_user_token fs on fu.token = fs.token where 1=1
            ]]>
            
        <!-- bind -->
		<isEqual compareValue="1" property="operType" prepend="and">
			exists (select otppms_user_token.token from
			otppms_user_token where otppms_user_token.token =
			fu.token)
		</isEqual>
		
		<!-- enabled -->
		<isEqual compareValue="2" property="operType" prepend="and">
			fu.enabled ='1'
		</isEqual>
		<!-- locked -->
		<isEqual compareValue="3" property="operType" prepend="and">
			fu.locked !='0'
		</isEqual>
		<!-- lost -->
		<isEqual compareValue="4" property="operType" prepend="and">
			fu.lost ='1'
		</isEqual>
		<!-- logout -->
		<isEqual compareValue="5" property="operType" prepend="and">
			fu.logout ='1'
		</isEqual>
		<!-- enable pin -->
		<isEqual compareValue="6" property="operType" prepend="and">
			fu.authmethod ='1'
		</isEqual>
		
		<include refid="queryReportConditionC" /> 
		<![CDATA[       		
        	order by fu.token asc
        ]]>
	</select>
	
	<!-- export token expire: time expire token info -->
	<select id="selectTokenByExpired" parameterClass="reportQueryInfo" resultClass="tokenInfo">
			<![CDATA[
				SELECT fu.token AS token ,fs.userid AS userid ,fs.domainid AS domainid
              		from otppms_tokeninfo fu left join otppms_user_token fs on fu.token = fs.token where 1=1
			]]>
			<include refid="queryReportConditionC" /> 
			<dynamic>
				<!-- week -->
				<isEqual compareValue="1" property="operType" prepend="and">
					<![CDATA[
						fu.expiretime <=#weekExpireTime# and fu.expiretime >= #nowtime#
					]]>
				</isEqual>
				<!-- month -->
				<isEqual compareValue="2" property="operType" prepend="and">
					<![CDATA[
						fu.expiretime <=#monthExpireTime# and fu.expiretime >= #nowtime#
					]]>
				</isEqual>
				<!-- quarter -->
				<isEqual compareValue="3" property="operType" prepend="and">
					<![CDATA[
						fu.expiretime <=#quarterExpireTime# and fu.expiretime >= #nowtime#
					]]>
				</isEqual>
				<!-- lg 3 months -->
				<isEqual compareValue="4" property="operType" prepend="and">
					<![CDATA[
						fu.expiretime >=#moreExpireTime#
					]]>
				</isEqual>
				
			</dynamic>
	</select>
	
	
</sqlMap>
