<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="agent_info">

	<typeAlias alias="agentInfo"
		type="com.ft.otp.manager.authmgr.agent.entity.AgentInfo" />
	<parameterMap class="agentInfo" id="parameterMap_at">
		<parameter property="agentname" javaType="string" jdbcType="VARCHAR" />
		<parameter property="agentipaddr" javaType="string" jdbcType="VARCHAR" />
		<parameter property="pubkey" javaType="string" jdbcType="VARCHAR" />
		<parameter property="enabled" javaType="int" jdbcType="INTEGER" />
		<parameter property="agenttype" javaType="int" jdbcType="INTEGER" />
		<parameter property="agentconfid" javaType="int" jdbcType="INTEGER" />
		<parameter property="graceperiod" javaType="int" jdbcType="INTEGER" />
		<parameter property="descp" javaType="string" jdbcType="VARCHAR" />
		<parameter property="hostIpAddr" javaType="string" jdbcType="VARCHAR" />
	</parameterMap>
	
	<!-- query agent common filter condition -->
	<sql id="queryAgentCondition">
		<dynamic>
			<!-- agentname -->
			<isNotNull property="agentname">
				<isNotEmpty property="agentname" prepend="and">
					fag.agentname = #agentname#
				</isNotEmpty>
			</isNotNull>
			<!-- agentIpAddr -->
			<isNotNull property="agentipaddr">
				<isNotEmpty property="agentipaddr" prepend="and">
					fag.agentipaddr like '%$agentipaddr$%'
				</isNotEmpty>
			</isNotNull>
		
			<!-- hostIpAddr -->
			<isNotNull property="hostIpAddr">
				<isNotEmpty property="hostIpAddr" prepend="and">
					exists (select otppms_agent_host.agentipaddr from
					otppms_agent_host where otppms_agent_host.agentipaddr =
					fag.agentipaddr and otppms_agent_host.hostipaddr like '%$hostIpAddr$%')
				</isNotEmpty>
			</isNotNull>
			
			<!-- agentConf -->
			<isNotNull property="agentconfid">
				<isNotEmpty property="agentconfid" >
					<isGreaterThan compareValue="0" property="agentconfid" prepend="and">
							fag.agentconfid = #agentconfid#
					</isGreaterThan>
				</isNotEmpty>
			</isNotNull>
			
			<!-- agentType -->
			<isNotNull property="batchIdsInt" prepend="and">
				fag.agenttype in
				<iterate property="batchIdsInt" open="(" close=")"
					conjunction=",">
					#batchIdsInt[]#
				</iterate>
			</isNotNull>
		</dynamic>
	</sql>
	
	<sql id="findAgentCondition">
		<dynamic>
			<isNotNull property="agentname">
				<isNotEmpty property="agentname" prepend="and">
					fag.agentname = #agentname#
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="agentipaddr">
				<isNotEmpty property="agentipaddr" prepend="and">
					fag.agentipaddr = #agentipaddr#
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="agentconfid">
				<isNotEmpty property="agentconfid" >
					<isGreaterThan compareValue="0" property="agentconfid" prepend="and">
							fag.agentconfid = #agentconfid#
					</isGreaterThan>
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="hostIpAddr">
				<isNotEmpty property="hostIpAddr" prepend="and">
					exists (select otppms_agent_host.agentipaddr from
					otppms_agent_host where otppms_agent_host.agentipaddr =
					fag.agentipaddr and otppms_agent_host.hostipaddr = #hostIpAddr#)
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="batchIdsInt" prepend="and">
				fag.agenttype in
				<iterate property="batchIdsInt" open="(" close=")"
					conjunction=",">
					#batchIdsInt[]#
				</iterate>
			</isNotNull>
		</dynamic>
	</sql>

	<insert id="insertAT" parameterClass="agentInfo">
		<![CDATA[
    		INSERT INTO otppms_agentinfo(agentipaddr,pubkey,enabled,agenttype,agentconfid,graceperiod,descp,agentname)
    		VALUES(#agentipaddr#,#pubkey#,#enabled#,#agenttype#,#agentconfid#,#graceperiod#,#descp#,#agentname#)
    	
    	]]>
	</insert>

	<select id="findAT" parameterClass="agentInfo"
		resultClass="agentInfo">
		<![CDATA[
    	SELECT
		     fag.enabled,
    		 fag.agentipaddr,
    		 fag.descp,
    		 fag.pubkey,
    		 fag.agenttype,
    		 fag.agentconfid,
    		 fag.graceperiod,
    		 fag.agentname
            from otppms_agentinfo fag where 1=1 
         ]]>
         <include refid="findAgentCondition"/>
	</select>
	
	<select id="findAG" parameterClass="agentInfo"
		resultClass="agentInfo">
		<![CDATA[
    	SELECT
		     fag.enabled,
    		 fag.agentipaddr,
    		 fag.descp,
    		 fag.pubkey,
    		 fag.agenttype,
    		 fag.agentconfid,
    		 fag.graceperiod,
    		 fag.agentname
            from otppms_agentinfo fag where fag.agentconfid=#agentconfid#
         ]]>
	</select>

    <select id="countAT" resultClass="int">
		<![CDATA[
            select count(agentipaddr) from otppms_agentinfo fag where 1=1
          ]]>
        <include refid="queryAgentCondition"/>
	</select>

	<delete id="deleteAT" parameterMap="parameterMap_at">
		<![CDATA[
    		DELETE FROM	otppms_agentinfo WHERE 1=1
    	]]>
		<dynamic prepend="">
			<isNotNull property="batchIds" prepend="and">
				agentipaddr IN
				<iterate property="batchIds" open="(" close=")"
					conjunction=",">
					#batchIds[]#
				</iterate>
			</isNotNull>
		</dynamic>
	</delete>

	<update id="updateAT" parameterClass="agentInfo">
		<![CDATA[
		   update otppms_agentinfo set agentname= #agentname#, descp = #descp#,enabled = #enabled#,pubkey = #pubkey#,agenttype = #agenttype#,agentconfid = #agentconfid#,graceperiod = #graceperiod# 
		   WHERE agentipaddr = #agentipaddr# 
         ]]>
	</update>
	
	<update id="updateEnabled" parameterClass="agentInfo">
		<![CDATA[
        update otppms_agentinfo set enabled=#enabled# where agentipaddr=#agentipaddr#  
     ]]>
	</update>

</sqlMap>
