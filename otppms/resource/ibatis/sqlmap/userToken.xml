<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="user_token">
	<typeAlias alias="userToken"
		type="com.ft.otp.manager.user_token.entity.UserToken" />

	<parameterMap class="userToken" id="parameterMap_ut">
	   <parameter property="bindId" javaType="int"
			jdbcType="INTEGER" />
		<parameter property="userId" javaType="string"
			jdbcType="VARCHAR" />
		<parameter property="token" javaType="string"
			jdbcType="VARCHAR" />
		<parameter property="userIds" javaType="string"
			jdbcType="VARCHAR" />
		<parameter property="tokenIds" javaType="string"
			jdbcType="VARCHAR" />

		<parameter property="startRow" javaType="int"
			jdbcType="INTEGER" />
		<parameter property="pageSize" javaType="int"
			jdbcType="INTEGER" />
	</parameterMap>
	
	<resultMap id="resultMap_ut" class="userToken">
		<result property="bindId" column="bindid" nullValue="0" />
		<result property="token" column="token" nullValue="" />
		<result property="userId" column="userid" nullValue="" />
		<result property="domainId" column="domainid"/>
	</resultMap>

	<insert id="insertUT" parameterClass="userToken">
		<![CDATA[
    		INSERT INTO otppms_user_token(userid,
    		token,domainid,bindtime)
    		VALUES(#userId#,#token#,#domainId#,#bindTime#)
    	]]>
	</insert>

	<select id="findUT" resultClass="userToken"
		parameterMap="parameterMap_ut">
		<![CDATA[
			SELECT ut.bindid,ut.userid,ut.domainid ,ut.token FROM
			 otppms_user_token  ut WHERE 1=1
         ]]>
		<dynamic prepend="">
			<isNotNull property="userId" prepend="and">
				<isNotEmpty property="userId">
					ut.userid = #userId#
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="token" prepend="and">
				<isNotEmpty property="token">
					ut.token = #token#
				</isNotEmpty>
			</isNotNull>
		</dynamic>
	</select>

	<select id="selectUT_Join_Tkn" resultClass="userToken"
		parameterMap="parameterMap_ut">
		<![CDATA[
		     SELECT  otppms_user_token.bindid,otppms_user_token.userid,otppms_user_token.token, 
               ftoken.producttype,ftoken.physicaltype,
		       ftoken.otplen,ftoken.intervaltime 
		      FROM otppms_user_token, (select tn.token,tn.producttype,tn.physicaltype,tp.otplen,tp.intervaltime from otppms_tokeninfo tn left join otppms_tokenspec tp on tn.specid=tp.specid ) ftoken
		       WHERE otppms_user_token.token = ftoken.token
         ]]>
		<dynamic prepend="">
			<isNotNull property="userId" prepend="and">
				<isNotEmpty property="userId">
					otppms_user_token.userid = #userId#
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="domainId" prepend="and">
				<isNotEmpty property="domainId">
					otppms_user_token.domainid = #domainId#
				</isNotEmpty>
			</isNotNull>
		</dynamic>
	</select>
	
	<select id="selectToken_IN" resultClass="userToken"
		parameterMap="parameterMap_ut">
		SELECT otppms_user_token.bindid,otppms_user_token.userid,otppms_user_token.domainid, otppms_user_token.token FROM
		otppms_user_token WHERE 1=1
		<dynamic prepend="">
			<isNotNull property="userIds" prepend="and">
				otppms_user_token.userid IN
				<iterate property="userIds" open="(" close=")"
					conjunction=",">
					#userIds[]#
				</iterate>
			</isNotNull>
			<isNotNull property="domainId" prepend="and">
				<isNotEmpty property="domainId">
					domainid = #domainId#
				</isNotEmpty>
			</isNotNull>
		</dynamic>
	</select>

	<!-- query user bind tokens -->
	<select id="selectUT_In" resultClass="userToken"
		parameterMap="parameterMap_ut">
		SELECT otppms_user_token.bindid,otppms_user_token.userid,otppms_user_token.domainid, otppms_user_token.token FROM
		otppms_user_token WHERE 1=1
		<dynamic prepend="">
			<isNotNull property="userIds" prepend="and">
				otppms_user_token.userid IN
				<iterate property="userIds" open="(" close=")"
					conjunction=",">
					#userIds[]#
				</iterate>
			</isNotNull>
			<isNotNull property="domainIds" prepend="and">
				otppms_user_token.domainid IN
				<iterate property="domainIds" open="(" close=")"
					conjunction=",">
					#domainIds[]#
				</iterate>
			</isNotNull>
			<isNotNull property="tokenIds" prepend="and">
				otppms_user_token.token IN
				<iterate property="tokenIds" open="(" close=")"
					conjunction=",">
					#tokenIds[]#
				</iterate>
			</isNotNull>
		</dynamic>
	</select>
	
	<!-- query admin bind tokens -->
	<select id="selectAdmBindTokens" resultClass="userToken"
		parameterMap="parameterMap_ut">
		SELECT bindid,userid,domainid,token FROM otppms_user_token WHERE 1=1 and domainid is null
		<dynamic prepend="">
		    <isNotNull property="userId" prepend="and">
				userid = #userId#
			</isNotNull>
			<isNotNull property="userIds" prepend="and">
				otppms_user_token.userid IN
				<iterate property="userIds" open="(" close=")"
					conjunction=",">
					#userIds[]#
				</iterate>
			</isNotNull>
			<isNotNull property="tokenIds" prepend="and">
				otppms_user_token.token IN
				<iterate property="tokenIds" open="(" close=")"
					conjunction=",">
					#tokenIds[]#
				</iterate>
			</isNotNull>
		</dynamic>
	</select>

	<delete id="deleteUT" parameterClass="userToken">
		<![CDATA[
			DELETE FROM otppms_user_token WHERE 1=1
		]]>
		<dynamic prepend="">
			<isNotNull property="userId" prepend="and">
				<isNotEmpty property="userId">
					userid = #userId#
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="domainId" prepend="and">
				<isNotEmpty property="domainId">
					domainid = #domainId#
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="token" prepend="and">
				<isNotEmpty property="token">
					token = #token#
				</isNotEmpty>
			</isNotNull>
		</dynamic>
	</delete>
	
	<delete id="deleteUse" parameterClass="userToken">
		<![CDATA[
			DELETE FROM otppms_user_token WHERE 1=1
		]]>
		<dynamic prepend="">
			<isNotNull property="userId" prepend="and">
				<isNotEmpty property="userId">
					userid != #userId#
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="domainId" prepend="and">
				<isNotEmpty property="domainId">
					domainid = #domainId#
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="token" prepend="and">
				<isNotEmpty property="token">
					token = #token#
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="userIds" prepend="and">
					userid NOT IN
				<iterate property="userIds" open="(" close=")"
					conjunction=",">
					#userIds[]#
				</iterate>
			</isNotNull>
		</dynamic>
	</delete>

	<delete id="deleteUTS" parameterClass="userToken">
		<![CDATA[
			DELETE FROM otppms_user_token WHERE 1=1
		]]>
		<dynamic prepend="">
			<isNotNull property="userId" prepend="and">
				<isNotEmpty property="userId">
					userid = #userId#
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="domainId">
				<isNotEmpty property="domainId" prepend="and">
					<isEqual compareValue="-1" property="domainId">
						domainid is null
					</isEqual>
					<isNotEqual compareValue="-1" property="domainId">
						domainid = #domainId# 
			    	</isNotEqual>
			    </isNotEmpty>
			</isNotNull>
			<isNotNull property="tokenIds" prepend="and">
				token IN
				<iterate property="tokenIds" open="(" close=")"
					conjunction=",">
					#tokenIds[]#
				</iterate>
			</isNotNull>
		</dynamic>
	</delete>

	<select id="countUT" resultClass="int"
		parameterMap="parameterMap_ut">
		<![CDATA[
	    	select count(bindid) from otppms_user_token where 1=1
	    ]]>
		<dynamic prepend="">
			<isNotNull property="userId" prepend="and">
				<isNotEmpty property="userId">
					userid = #userId#
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="domainId" prepend="and">
				<isNotEmpty property="domainId">
					<isNotEqual compareValue="0" property="domainId">	
						<isNotEqual compareValue="-1" property="domainId">
							domainid = #domainId#
						</isNotEqual>
						<isEqual compareValue="-1" property="domainId">
							domainid is null
						</isEqual>
					</isNotEqual>
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="token" prepend="and">
				<isNotEmpty property="token">
					token = #token#
				</isNotEmpty>
			</isNotNull>
		</dynamic>
	</select>

		
	<!-- find user bind tokens and the token is other user bind -->
	<select id="queryMulUserToken" resultClass="userToken"
		parameterMap="parameterMap_ut">
		<![CDATA[
			SELECT fut.token  FROM     otppms_user_token fut   WHERE 1=1   
         ]]>	
         <dynamic prepend="">
			<isNotNull property="userId" prepend="and">
				<isNotEmpty property="userId">
					fut.userid = #userId#	
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="domainId" prepend="and">
				<isNotEmpty property="domainId">
					fut.domainid = #domainId#	
				</isNotEmpty>
			</isNotNull>
			<isNull property="domainId" prepend="and">
				fut.domainid is null
			</isNull>
			
			<isNotNull property="bindTag" prepend="and">
				<isEqual compareValue="0" property="bindTag" > <!-- single user bind's tokens -->
					fut.token in( SELECT ftut.token  FROM     otppms_user_token ftut  group by ftut.token having count(ftut.token)=1)
				</isEqual>
				<isEqual compareValue="1" property="bindTag" > <!-- multi user bind's tokens -->
					 fut.token in( SELECT ftut.token  FROM     otppms_user_token ftut  group by ftut.token having count(ftut.token)>1)
				</isEqual>
			</isNotNull>
			
		</dynamic>			
	</select>
	
	<!-- query token user relation table and the token y/s is admin bind by token id -->
	<select id="selectUTS" resultClass="userToken" parameterMap="parameterMap_ut">
		<![CDATA[
			select tn.userid,
       			   tn.token,
       			   tn.domainid,
       			   CASE (select count(userid) from otppms_user_token tm
          					where tm.token = #token# and domainid is null)
         						when 0 then 0 else 1 end as isNullDomain
         	from otppms_user_token tn where 1=1
		]]>
		<dynamic prepend="">
			<isNotNull property="token" prepend="and">
				<isNotEmpty property="token">
					tn.token = #token#	
				</isNotEmpty>
			</isNotNull>
		</dynamic>
	</select>
	
	<!-- query user token relation info by user id -->
	<select id="selectTOKS" resultClass="userToken" parameterMap="parameterMap_ut">
		<![CDATA[
			select * FROM otppms_user_token WHERE 1=1
		]]>
		<dynamic prepend="">
			<isNotNull property="userId" prepend="and">
				<isNotEmpty property="userId">
					userid = #userId#	
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="domainId" prepend="and">
				<isNotEmpty property="domainId">
					domainId = #domainId#	
				</isNotEmpty>
			</isNotNull>
		</dynamic>
	</select>
	
	<!-- query the user and other user together bind same token by token and userid -->
	<select id="selectOTH" resultClass="userToken" parameterMap="parameterMap_ut">
		<![CDATA[
			select tn.userid,
       			   tn.token,
       			   tn.domainid 
				 FROM otppms_user_token tn WHERE 1=1
		]]>
		<dynamic prepend="">
			<isNotNull property="userIds" prepend="and">
					tn.userid NOT IN
				<iterate property="userIds" open="(" close=")"
					conjunction=",">
					#userIds[]#
				</iterate>
			</isNotNull>
			<isNotNull property="domainId" prepend="and">
				<isNotEmpty property="domainId">
					tn.domainId = #domainId#	
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="token" prepend="and">
				<isNotEmpty property="token">
					tn.token = #token#	
				</isNotEmpty>
			</isNotNull>
		</dynamic>
	</select>
	
	<select id="selectBTH" resultClass="userToken" parameterMap="parameterMap_ut">
		<![CDATA[
			select tn.userid,
       			   tn.token,
       			   tn.domainid 
				 FROM otppms_user_token tn WHERE 1=1
		]]>
		<dynamic prepend="">
			<isNotNull property="userId" prepend="and">
				<isNotEmpty property="userId">
					tn.userid = #userId#	
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="domainId" prepend="and">
				<isNotEmpty property="domainId">
					tn.domainId = #domainId#	
				</isNotEmpty>
			</isNotNull>
		</dynamic>
	</select>
	
</sqlMap>
