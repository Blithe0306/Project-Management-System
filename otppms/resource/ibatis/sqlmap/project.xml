<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="project">
	<typeAlias alias="project"
		type="com.ft.otp.manager.project.entity.Project" />
	<typeAlias alias="adminUser"
		type="com.ft.otp.manager.admin.user.entity.AdminUser" />

	<parameterMap class="project" id="parameterMap_ui">
		<parameter property="prjname" javaType="string" jdbcType="VARCHAR" />
		<parameter property="prjid" javaType="string" jdbcType="VARCHAR" />
		<parameter property="custid" javaType="string" jdbcType="VARCHAR" />
		<parameter property="startTime" javaType="int" jdbcType="INTEGER" />
		<parameter property="endTime" javaType="int" jdbcType="INTEGER" />
		<parameter property="custname" javaType="string" jdbcType="VARCHAR" />

		<parameter property="startRow" javaType="int"
			jdbcType="INTEGER" />
		<parameter property="pageSize" javaType="int"
			jdbcType="INTEGER" />
	</parameterMap>

	<resultMap id="resultMap_ui" class="project">
		<result property="prjid" column="prjid" nullValue="" />
		<result property="prjname" column="prjname" nullValue="" />
		<result property="custid" column="custid" nullValue="" />
		<result property="custname" column="custname" nullValue="" />
		<result property="type" column="type" nullValue="" />
		<result property="typeversion" column="typeversion" nullValue="" />
		<result property="prjstate" column="prjstate" nullValue="" />
		<result property="needdept" column="needdept" nullValue="" />
		<result property="sales" column="sales" nullValue="" />
		<result property="techsupport" column="techsupport" nullValue="" />
		<result property="ifpay" column="ifpay" nullValue="" />
		<result property="svn" column="svn" nullValue="" />
		<result property="bug" column="bug" nullValue="" />
		<result property="prjdesc" column="prjdesc" nullValue="" />
		<result property="createtime" column="createtime" nullValue="" />
	</resultMap>
	
	<sql id="queryPrjConditionUC">
        <![CDATA[
	    	WHERE 1=1
	    ]]>
		<dynamic prepend="">			
			<isNotNull property="prjid" prepend="and">
				<isNotEmpty property="prjid">
					p.prjid like '%$prjid$%'
				</isNotEmpty>
			</isNotNull>
			<isNotNull>
				<isNotEmpty property="prjname" prepend="and">
					p.prjname like '%$prjname$%'
				</isNotEmpty>
			</isNotNull>
		</dynamic>
	</sql>
	
	<select id="selectPowerAdmin" resultClass="adminUser" >
		<![CDATA[
			select ai.* from otppms_admininfo ai 
			left join otppms_admin_role ar on ar.adminid = ai.adminid
			left join otppms_roleinfo ri on ri.roleid = ar.roleid
			where ri.roleid='1'
		 ]]>
	</select>

	<select id="countPrjUI" resultClass="int" parameterClass="project">
		<![CDATA[
	    	select count(p.prjid) from otppms_project p where 1=1 
	    ]]>
	     <dynamic prepend="">
			<isNotNull property="custid" prepend="and">
				<isNotEmpty property="custid">
					p.custid = #custid#
				</isNotEmpty>
			</isNotNull>
		</dynamic>
	</select>
	
	<select id="selectPrj" resultClass="project" parameterClass="project">
		<![CDATA[
	    	 SELECT 
		       p.id,
		       p.prjid,
		       p.prjname,
		       p.custid,
		       p.type,
		       p.typeversion,
		       p.prjstate,
		       p.needdept,
		       p.sales,p.techsupport,
		       p.ifpay,
		       p.svn,
		       p.bug,
		       p.prjdesc,
		       p.createtime,
		       p.operator,
		       p.updatetime,
		       c.custname
		   from otppms_project p left join otppms_customer c
		  on c.id = p.custid where 1=1 
	    ]]>
	    <dynamic prepend="">
	    	<isGreaterThan compareValue="0" property="id" prepend="and">
					<![CDATA[ p.id = #id# ]]>
			</isGreaterThan>
			<isNotNull property="prjname" prepend="and">
				<isNotEmpty property="prjname">
					p.prjname like '%$prjname$%'
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="prjid" prepend="and">
				<isNotEmpty property="prjid">
					p.prjid like '%$prjid$%'
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="custid" prepend="and">
				<isNotEmpty property="custid">
					p.custid = #custid#
				</isNotEmpty>
			</isNotNull>
			<isGreaterThan compareValue="0" property="startTime" prepend="and">
					<![CDATA[ p.createtime >= #startTime# ]]>
			</isGreaterThan>
			<isGreaterThan compareValue="0" property="endTime" prepend="and">
					<![CDATA[ p.createtime <= #endTime# ]]>
			</isGreaterThan>
		</dynamic>
		<![CDATA[
	    	order by p.createtime desc 
	    ]]>
		<![CDATA[
			LIMIT #pageSize# OFFSET #startRow#
		]]>
	</select>
	
	<select id="findPrj" resultClass="project" parameterClass="project">
		<![CDATA[
	    	 SELECT 
		       p.id,
		       p.prjid,
		       p.prjname,
		       p.custid,
		       p.type,
		       p.typeversion,
		       p.prjstate,
		       p.needdept,
		       p.sales,p.techsupport,
		       p.ifpay,
		       p.svn,
		       p.bug,
		       p.prjdesc,
		       p.createtime,
		       p.operator,
		       p.updatetime,
		       c.custname
		   from otppms_project p left join otppms_customer c
		  on c.id = p.custid where 1=1 
	    ]]>
	    <dynamic prepend="">
			<isNotNull property="id" prepend="and">
				<isNotEmpty property="id">
					p.id = #id#
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="prjname" prepend="and">
				<isNotEmpty property="prjname">
					p.prjname = #prjname#
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="prjid" prepend="and">
				<isNotEmpty property="prjid">
					p.prjid = #prjid#
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="custid" prepend="and">
				<isNotEmpty property="custid">
					p.custid = #custid#
				</isNotEmpty>
			</isNotNull>
		</dynamic>
		<![CDATA[
	    	order by p.createtime desc 
	    ]]>
	</select>
	
	<!-- 特殊查询，除自身以外的查询 -->
	<select id="findPrjExceptself" resultClass="project" parameterClass="project">
		<![CDATA[
	    	 SELECT 
		       id,
		       prjid,
		       prjname,
		       custid,
		       type,
		       typeversion,
		       prjstate,
		       needdept,
		       sales,
		       techsupport,
		       ifpay,
		       svn,
		       bug,
		       prjdesc,
		       createtime,
		       operator,
		       updatetime
		   from otppms_project p where 1=1 
	    ]]>
	    <dynamic prepend="">
	        <isNotNull property="id" prepend="and">
				<isNotEmpty property="id">
					p.id != #id#
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="prjname" prepend="and">
				<isNotEmpty property="prjname">
					p.prjname = #prjname#
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="prjid" prepend="and">
				<isNotEmpty property="prjid">
					p.prjid = #prjid#
				</isNotEmpty>
			</isNotNull>
		</dynamic>
	</select>

	<insert id="insertPrjUI" parameterClass="project">
		<![CDATA[
    		INSERT INTO otppms_project(
    		prjid,
    		prjname,
    		custid,
    		type,
    		typeversion,
    		prjstate,
    		needdept,
    		sales,
    		techsupport,
    		ifpay,
    		svn,
    		bug,
    		prjdesc,
    		createtime,
    		operator,
    		updatetime
			)
    		VALUES(#prjid#,#prjname#,#custid#,#type#,#typeversion#,
    		#prjstate#,#needdept#,#sales#,#techsupport#,
    		#ifpay#,#svn#,#bug#,#prjdesc#,#createtime#,#operator#,#updatetime#)
    	]]>
	</insert>
    
    <!-- update projects base info -->
    <update id="updatePrjUI" parameterClass="project">
		<![CDATA[
			UPDATE otppms_project SET 
			prjid=#prjid#,
    		prjname=#prjname#,
    		custid=#custid#,
    		type=#type#,
    		typeversion=#typeversion#,
    		prjstate=#prjstate#,
    		needdept=#needdept#,
    		sales=#sales#,
    		techsupport=#techsupport#,
    		svn=#svn#,
    		ifpay=#ifpay#,
    		bug=#bug#,
    		prjdesc=#prjdesc#,
    		updatetime=#updatetime#
			WHERE  1=1 
		]]>
		<isNotNull>
			<isNotEmpty property="id" prepend="and">
				id = #id#
			</isNotEmpty>
		</isNotNull>
	</update>
	
	<!-- delete project -->
	<delete id="deletePrjUI" parameterClass="project">
		<![CDATA[
			DELETE FROM otppms_project WHERE 1=1 and id = #id#
		]]>
	</delete>
</sqlMap>
