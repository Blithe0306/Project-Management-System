<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="token_info">
	<select id="selectTK" resultMap="resultMap_tk"
		parameterMap="parameterMap_tk">
		<![CDATA[
		    SELECT
	    		tn.token,
	    		tn.enabled,
	    		tn.locked,
	    		tn.lost,
	    		tn.logout,
	    		
	    		tn.authnum,
	    		tn.authmethod,
	    		tn.empin  ,
	    		tn.empindeath ,
	    		tn.expiretime,
	    		tn.syncwnd,
	    		tn.temploginerrcnt,  
	    		tn.longloginerrcnt,  
	    		tn.loginlocktime,
	    		tn.driftcount,
	    		tn.physicaltype,
	    		tn.producttype,
	    		tn.specid,
	    		tn.domainid,
	    		tn.orgunitid,
	    		tn.gensmstime,
	    		tn.importtime,
	    		tn.distributetime,
	    		tn.crauthnum  ,
				tn.authtime , 
				tn.crauthtime  ,
				tn.authotp  ,
				tn.crauthotp ,
				tn.crauthdata  ,
				tn.cractivecode  ,
				tn.pubkeystate  ,
				tn.newpubkey  ,
				tn.cractivetime  ,
				tn.cractivecount, 
				tn.vendorid,
	    		CASE (select count(bindid) from otppms_user_token where otppms_user_token.token =tn.token)
	    		WHEN 0  THEN 0
	    				ELSE 1 
	    		END   
	    		AS bindTag 
                from 
            ]]>
            
		    <dynamic prepend="">
	         	<isNotNull property="pageSize" prepend="">
					<isNotEmpty property="pageSize">
						(select top $pageSize$ tn.* from otppms_tokeninfo tn where 1=1
					</isNotEmpty>
				</isNotNull>
				<include refid="queryTokensCondition" /> 
				<isNotNull property="startRow" prepend="">
					<isNotEmpty property="startRow">
					 	and tn.token not in (select top $startRow$ tn.token from otppms_tokeninfo tn where 1=1
					</isNotEmpty>
				</isNotNull>
				<include refid="queryTokensCondition" /> 
	        </dynamic>
		 	<![CDATA[       		
        		order by tn.token asc) order by tn.token asc) tn order by tn.token asc
       		]]>
	</select>
	
	<!-- special filter -->
	<select id="selectTKBC" resultMap="resultMap_tk"
		parameterMap="parameterMap_tk">
		<![CDATA[
		    SELECT
	    		tn.token,
	    		tn.enabled,
	    		tn.locked,
	    		tn.lost,
	    		tn.logout,
	    		
	    		tn.authnum,
	    		tn.authmethod,
	    		tn.empin  ,
	    		tn.empindeath ,
	    		tn.expiretime,
	    		tn.syncwnd,
	    		tn.temploginerrcnt,  
	    		tn.longloginerrcnt,  
	    		tn.loginlocktime,
	    		tn.driftcount,
	    		tn.physicaltype,
	    		tn.producttype,
	    		tn.specid,
	    		tn.domainid,
	    		tn.orgunitid,
	    		tn.gensmstime,
	    		tn.importtime,
				tn.distributetime,
	    		tn.crauthnum  ,
				tn.authtime , 
				tn.crauthtime  ,
				tn.authotp  ,
				tn.crauthotp ,
				tn.crauthdata  ,
				tn.cractivecode  ,
				tn.pubkeystate  ,
				tn.newpubkey  ,
				tn.cractivetime  ,
				tn.cractivecount, 
				tn.vendorid,
	    		CASE (select count(bindid) from otppms_user_token where otppms_user_token.token =tn.token)
	    		when 0  then 0
	    				else 1 
	    		end   
	    		as bindTag 
           		from 
            ]]>
            
        <dynamic prepend="">
			<isNotNull property="upPageTag">
				<isNotEmpty property="upPageTag">
					<isEqual compareValue="1" property="upPageTag"><!-- 1 page ,0 not page -->
						<isNotNull property="pageSize" prepend="">
							<isNotEmpty property="pageSize">
								(select top $pageSize$ tn.* from otppms_tokeninfo tn where 1=1
							</isNotEmpty>
						</isNotNull>
						<include refid="queryTokensConditionBC" /> 
						<isNotNull property="startRow" prepend="">
							<isNotEmpty property="startRow">
							 	and tn.token not in (select top $startRow$ tn.token from otppms_tokeninfo tn where 1=1 <include refid="queryTokensConditionBC" /> order by tn.token asc) order by tn.token asc) tn
							</isNotEmpty>
						</isNotNull>
            		</isEqual>
            		<isEqual compareValue="0" property="upPageTag"><!-- 1 page,0 not page -->
						otppms_tokeninfo tn where 1=1 <include refid="queryTokensConditionBC" /> 
            		</isEqual>
				</isNotEmpty>
			</isNotNull>			
		</dynamic>	     
		 <![CDATA[       		
        	order by tn.token asc
        ]]>
	</select>
	
	<!-- change token -->
	<select id="selectCT" resultMap="resultMap_tk"
		parameterMap="parameterMap_tk">
		<![CDATA[
		    SELECT
	    		tn.token,
	    		tn.enabled,
	    		tn.locked,
	    		tn.lost,
	    		tn.logout,
	    		tn.authnum,
	    		tn.authmethod,
	    		tn.empin  ,
	    		tn.empindeath ,
	    		tn.expiretime,
	    		tn.syncwnd,
	    		tn.temploginerrcnt,  
	    		tn.longloginerrcnt,  
	    		tn.loginlocktime,
	    		tn.driftcount,
	    		tn.physicaltype,
	    		tn.producttype,
	    		tn.specid,
	    		tn.domainid,
	    		tn.orgunitid,
	    		tn.gensmstime,
	    		tn.importtime,
				tn.distributetime,
	    		tn.crauthnum  ,
				tn.authtime , 
				tn.crauthtime  ,
				tn.authotp  ,
				tn.crauthotp ,
				tn.crauthdata  ,
				tn.cractivecode  ,
				tn.pubkeystate  ,
				tn.newpubkey  ,
				tn.cractivetime  ,
				tn.cractivecount, 
				tn.vendorid,
	    		CASE (select count(bindid) from otppms_user_token where otppms_user_token.token =tn.token)
	    		when 0  then 0
	    				else 1 
	    		end   
	    		as bindTag 
           		from 
            ]]>
            
        <dynamic prepend="">
			<isNotNull property="upPageTag">
				<isNotEmpty property="upPageTag">
					<isEqual compareValue="1" property="upPageTag"><!-- 1 page ,0 not page -->
						<isNotNull property="pageSize" prepend="">
							<isNotEmpty property="pageSize">
								(select top $pageSize$ tn.* from otppms_tokeninfo tn where 1=1
							</isNotEmpty>
						</isNotNull>
						<include refid="queryTokensConditionCT" /> 
						<isNotNull property="startRow" prepend="">
							<isNotEmpty property="startRow">
							 	and tn.token not in (select top $startRow$ tn.token from otppms_tokeninfo tn where 1=1 <include refid="queryTokensConditionCT" /> order by tn.token asc) order by tn.token asc) tn
							</isNotEmpty>
						</isNotNull>
            		</isEqual>
            		<isEqual compareValue="0" property="upPageTag"><!-- 1 page,0 not page -->
						otppms_tokeninfo tn where 1=1 <include refid="queryTokensConditionCT" /> 
            		</isEqual>
				</isNotEmpty>
			</isNotNull>			
		</dynamic>	     
		 <![CDATA[       		
        	order by tn.token asc
        ]]>
	</select>
 </sqlMap>
