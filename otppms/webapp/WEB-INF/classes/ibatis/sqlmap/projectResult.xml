<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="project_result">
	<typeAlias alias="projectResult"
		type="com.ft.otp.manager.project.entity.ProjectResult" />

	<parameterMap class="projectResult" id="parameterMap_ui">
		<parameter property="id" javaType="int" jdbcType="INTEGER" />
		<parameter property="prjid" javaType="string" jdbcType="VARCHAR" />
		<parameter property="results" javaType="string" jdbcType="VARCHAR" />
		<parameter property="operator" javaType="string" jdbcType="VARCHAR" />
		<parameter property="startRow" javaType="int" jdbcType="INTEGER" />
		<parameter property="pageSize" javaType="int" jdbcType="INTEGER" />
	</parameterMap>

	<resultMap id="resultMap_ui" class="projectResult">
		<result property="id" column="id" nullValue="" />
		<result property="prjid" column="prjid" nullValue="" />
		<result property="results" column="results" nullValue="" />
		<result property="operator" column="operator" nullValue="" />
		<result property="createtime" column="createtime" nullValue="" />
	</resultMap>
	
	<sql id="queryPrjConditionUC">
        <![CDATA[
	    	WHERE 1=1
	    ]]>
		<dynamic prepend="">			
			<isNotNull property="prjid" prepend="and">
				<isNotEmpty property="prjid">
					r.prjid = '$prjid$'
				</isNotEmpty>
			</isNotNull>
			<isNotNull>
				<isNotEmpty property="id" prepend="and">
					r.id = '$id$'
				</isNotEmpty>
			</isNotNull>
		</dynamic>
	</sql>

	<select id="countPrjUIResult" resultClass="int" parameterClass="projectResult">
		<![CDATA[
	    	select count(r.id) from otppms_project_result r where 1=1 
	    ]]>
	     <dynamic prepend="">
			<isNotNull property="prjid" prepend="and">
				<isNotEmpty property="prjid">
					r.prjid like '$prjid$'
				</isNotEmpty>
			</isNotNull>
		</dynamic>
	</select>
	
	<select id="selectPrjResult" resultClass="projectResult" parameterClass="projectResult">
		<![CDATA[
	    	select r.id,r.prjid,p.prjname,r.results,r.operator,r.createtime 
			from otppms_project_result r
			left join otppms_project p on p.prjid = r.prjid
			where 1=1
	    ]]>
	    <dynamic prepend="">
	    	<isGreaterThan compareValue="0" property="id" prepend="and">
					<![CDATA[ r.id = #id# ]]>
			</isGreaterThan>
			<isNotNull property="prjid" prepend="and">
				<isNotEmpty property="prjid">
					r.prjid like '$prjid$'
				</isNotEmpty>
			</isNotNull>
		</dynamic>
		<![CDATA[
	    	order by r.createtime desc 
	    ]]>
		<![CDATA[
			LIMIT #pageSize# OFFSET #startRow#
		]]>
	</select>
	
	<select id="findPrjResult" resultClass="projectResult" parameterClass="projectResult">
		<![CDATA[
	    	select r.id,r.prjid,p.prjname,r.results,r.operator,max(r.createtime) as createtime 
		  	from otppms_project_result r
			left join otppms_project p on p.prjid = r.prjid
			where 1=1
	    ]]>
	    <dynamic prepend="">
			<isGreaterThan compareValue="0" property="id" prepend="and">
					<![CDATA[ r.id = #id# ]]>
			</isGreaterThan>
			<isNotNull property="prjid" prepend="and">
				<isNotEmpty property="prjid">
					r.prjid = #prjid#
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="operator" prepend="and">
				<isNotEmpty property="operator">
					r.operator = #operator#
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="createtime" prepend="and">
				<isNotEmpty property="createtime">
					r.createtime = (select max(createtime) 
					from otppms_project_result where operator = #operator# and prjid = #prjid#)
				</isNotEmpty>
			</isNotNull>
		</dynamic>
		<![CDATA[
	    	order by r.createtime desc 
	    ]]>
	</select>
	
	<insert id="insertPrjUIResult" parameterClass="projectResult">
		<![CDATA[
    		INSERT INTO otppms_project_result(prjid,results,operator,createtime)
    		VALUES(#prjid#,#results#,#operator#,#createtime#)
    	]]>
	</insert>
    
    <!-- update projects base info -->
    <update id="updatePrjUIResult" parameterClass="projectResult">
		<![CDATA[
			UPDATE otppms_project_result SET 
			prjid=#prjid#,
    		results=#results#
			WHERE  1=1 
		]]>
		<isGreaterThan compareValue="0" property="id" prepend="and">
					<![CDATA[ id = #id# ]]>
		</isGreaterThan>
	</update>
	
	<!-- delete project -->
	<delete id="deletePrjUIResult" parameterClass="projectResult">
		<![CDATA[
			DELETE FROM otppms_project_result WHERE 1=1 and id = #id#
		]]>
	</delete>
</sqlMap>
