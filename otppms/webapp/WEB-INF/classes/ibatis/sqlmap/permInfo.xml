<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="admin_perm">
	<typeAlias alias="adminPerm"
		type="com.ft.otp.manager.admin.perm.entity.AdminPerm" />
	<typeAlias alias="adminPermCode"
		type="com.ft.otp.manager.admin.admin_perm.entity.AdminPermCode" />	
		
	<parameterMap class="adminPerm" id="parameterMap_ap">
		<parameter property="permCode" javaType="string"
			jdbcType="VARCHAR" />
	</parameterMap>

	<select id="selectAP" resultClass="adminPerm"
		parameterMap="parameterMap_ap">
		<![CDATA[
	   	SELECT
			permcode,
			permlink,
			srcname,
			keymark,
			descp
            FROM otppms_perminfo WHERE 1=1 
         ]]>
		<dynamic prepend="">
		
            <isNotEqual compareValue="ADMIN" property="curLoginUserRole" prepend="and">
				 permcode in (select permcode from otppms_role_perm 
                  where roleid in (select roleid from otppms_admin_role where adminid = #loginUser#))    
			</isNotEqual>
			
			<isNotNull property="permCode" prepend="and">
				<isNotEmpty property="permCode">
					permcode like '%$permCode$'
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="batchIds" prepend="and">
				<isNotEmpty property="batchIds">
				 permcode in 
					<iterate property="batchIds" open="(" close=")"
									conjunction=",">
									#batchIds[]#
								</iterate>
				</isNotEmpty>
			</isNotNull>
		</dynamic>
		<![CDATA[
			order by permcode asc
		]]>
	</select>

	<select id="countAP" resultClass="int"
		parameterClass="adminPerm">
		<![CDATA[
	    	SELECT count(*) from otppms_perminfo where 1=1
	    ]]>
	 
	</select>
	
	<select id="selectRoleAP" resultClass="adminPerm"
		parameterMap="parameterMap_ap">
		<![CDATA[
	   	SELECT
			permcode,
			permlink,
			srcname,
			keymark,
			descp
            FROM otppms_perminfo WHERE 1=1 
         ]]>
		<dynamic prepend="">
			<isNotNull property="roleId" prepend="and">
				<isNotEmpty property="roleId">
					permcode in (select permcode from otppms_role_perm 
                  	where roleid = #roleId#) 
				</isNotEmpty>
			</isNotNull>
		</dynamic>
		<![CDATA[
			order by permcode asc
		]]>
	</select>
	
	<!-- admin Common functions,add common permcode -->
	<insert id="addPermCode" parameterClass="adminPermCode">
		<![CDATA[ 
		   insert into otppms_admin_perm(adminid, permcode)values(#adminid#, #permcode#)
		]]>
	</insert>
	
	<!-- admin Common functions, delete common permcode -->
	<delete id="delPermCode" parameterClass="adminPermCode">
		<![CDATA[
    		DELETE FROM	otppms_admin_perm WHERE adminid = #adminid# 
    	]]>
		<dynamic prepend="">
			<isNotNull property="permcode" prepend="and">
				<isNotEmpty property="permcode">
					permcode = #permcode#
				</isNotEmpty>
			</isNotNull>
		
			<isNotNull property="batchIds" prepend="and">
				permcode IN
				<iterate property="batchIds" open="(" close=")"
					conjunction=",">
					#batchIds[]#
				</iterate>
			</isNotNull>
		</dynamic>
	</delete>
	
	<!-- query admin common functions perm -->
	<select id="selectPermCode" resultClass="adminPermCode" parameterClass="adminPermCode">
		<![CDATA[
	    	SELECT adminid,permcode from otppms_admin_perm where adminid=#adminid# 
	    ]]>
	    <dynamic prepend="">
			<isNotNull property="permcode" prepend="and">
				<isNotEmpty property="permcode">
					permcode = #permcode#
				</isNotEmpty>
			</isNotNull>
		</dynamic>
	</select>
	
</sqlMap>
